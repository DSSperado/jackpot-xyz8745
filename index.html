<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ìŠ¬ë¡¯ë¨¸ì‹ </title>
<style>
  :root{
    /* â–· ë¦´ ìœ„ì¹˜/í¬ê¸°: í”„ë ˆì„ ëŒ€ë¹„ â€˜í¼ì„¼íŠ¸(%)â€™ ê°’ (ì´ˆê¸°ê°’: ëŒ€ì¶© ë§ì¶˜ ê°’) */
    --REEL_TOP_PCT: 35.4;     /* í”„ë ˆì„ ë†’ì´ ëŒ€ë¹„ ìœ„ìª½ ì—¬ë°±(%) */
    --REEL_LEFT0_PCT: 16;   /* ì²« ë¦´ì˜ ì¢Œì¸¡ ìœ„ì¹˜(%) */
    --REEL_W_PCT: 15.8;       /* ë¦´ ë„ˆë¹„(%) */
    --REEL_H_PCT: 18.6;       /* ë¦´ ë†’ì´(%) */
    --REEL_GAP_PCT: 7.2;      /* ë¦´ ì‚¬ì´ ê°„ê²©(%) */
    --STATUS_LEFT: 30%;      /* X ì¢Œí‘œ (ê°€ìš´ë° ì •ë ¬í•˜ë ¤ë©´ % ì‚¬ìš©) */
    --STATUS_TOP:  74.6%;      /* Y ì¢Œí‘œ: í”„ë ˆì„ ë†’ì´ ëŒ€ë¹„ */
    --STATUS_W:    375px;    /* ë°•ìŠ¤ ë„ˆë¹„ */
    --STATUS_H:    130px;     /* ë°•ìŠ¤ ë†’ì´ */
    --s: 1;    /* ìŠ¤ì¼€ì¼ëŸ¬ */
  }

  html,body{height:100%;margin:0;background:#fff4e0;font-family:system-ui,Pretendard,Noto Sans KR,sans-serif; overflow: hidden; }
  body{
  min-height: 100svh;            /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ë†’ì´ ì´ìŠˆ ëŒ€ì‘ */
  margin: 0;
  display: flex;
  flex-direction: column;         /* í”„ë ˆì„ ìœ„, ë²„íŠ¼ ì•„ë˜ ì„¸ë¡œ ì •ë ¬ */
  justify-content: center;        /* ì„¸ë¡œ ì¤‘ì•™ */
  align-items: center;            /* ê°€ë¡œ ì¤‘ì•™ */
  gap: 12px;                      /* í”„ë ˆì„ê³¼ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
  padding: 16px 12px;             /* ê°€ì¥ìë¦¬ ì—¬ë°± (ì‘ì€ í™”ë©´ ë³´í˜¸) */
  background: #ffffff;            /* ê¸°ì¡´ ë°°ê²½ ìœ ì§€ */
  }
  #stage{
    width:750px;
    height:1200px;
    position:absolute;
    left:50%; top:54%;
    transform:translate(-50%,-50%) scale(var(--s));
    transform-origin:50% 50%;
  }
  .slot-wrap{
    position: relative;
    width: min(95vw, 750px);
    aspect-ratio: 380 / 540;
    margin: 0;
  }

  /* í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ ê½‰ ì±„ì›€ */
  .slot-frame{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    pointer-events:none; user-select:none;
    border-radius:10px;
  }

  /* ë¦´ 3ê°œ: í¼ì„¼íŠ¸ ê¸°ë°˜ ìœ„ì¹˜ */
  .reel{
    position:absolute;
    top: calc(var(--REEL_TOP_PCT) * 1%);
    width: calc(var(--REEL_W_PCT) * 1%);
    height: calc(var(--REEL_H_PCT) * 1%);
    display:grid; place-items:center;
    background:#fff; border-radius:10px;
    box-shadow:0 8px 20px rgba(0,0,0,.18);
    font-size: clamp(36px, 7vw, 60px);
    line-height:1; overflow:hidden;
  }
  .reel.r0{ left: calc(var(--REEL_LEFT0_PCT) * 1%); }
  .reel.r1{ left: calc((var(--REEL_LEFT0_PCT) + var(--REEL_W_PCT) + var(--REEL_GAP_PCT)) * 1%); }
  .reel.r2{ left: calc((var(--REEL_LEFT0_PCT) + (var(--REEL_W_PCT) + var(--REEL_GAP_PCT)) * 2) * 1%); }

  .face{ position:relative; width:100%; height:100%; display:grid; place-items:center; transition: transform 0.35s ease-out; }
  .sym-label { display: none; }


  /* íšŒì „ ì¤‘ ì‚´ì§ í”ë“¤ë¦¼ */
  .reel.spinning .face{ animation:shimmy 200ms linear infinite; }
  @keyframes shimmy { 0%{transform:translateY(-2%)} 50%{transform:translateY(2%)} 100%{transform:translateY(-2%)} }

  /* ì»¨íŠ¸ë¡¤ */
  .ctrl{ position: relative; display:flex; gap:12px; justify-content:center; align-items:center; margin:10px auto 0; width:min(90vw, 520px); height: 80px; }
  button{ cursor:pointer; border:0; border-radius:12px; padding:12px 22px; font-weight:800; background:#e63946; color:#fff; box-shadow:0 4px 0 #a31628; }
  .ctrl button {
    position: absolute;
    font-size: 1.5rem;   /* ê¸€ì í¬ê¸° í‚¤ìš°ê¸° */
    padding: 16px 28px;  /* ì„¸ë¡œÂ·ê°€ë¡œ ì—¬ë°± í™•ëŒ€ */
    left: 170px;
    top: -30px;
  }
  button:active{ transform:translateY(2px); box-shadow:0 2px 0 #a31628; }
  .status{
    color: #fff;             /* í°ìƒ‰ ê¸€ì”¨ */
    font-size: 2.5rem;
    font-weight: 900;
  }
  .status.win{ color:#fff; } .status.lose{ color:#fff; }
  .status-box{
    position: absolute;
    left: calc(var(--STATUS_LEFT) - var(--STATUS_W)/2); /* ê°€ìš´ë° ì •ë ¬ìš© */
    top: var(--STATUS_TOP);
    width: var(--STATUS_W);
    height: var(--STATUS_H);
    background: #df3b1b;     /* ë¹¨ê°„ìƒ‰ */
    border-radius: 6px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,.15);
    z-index: 5;
  }

  /* === ìœ„ì¹˜ ì¡°ì • ëª¨ë“œ(ìº˜ë¦¬ë¸Œë ˆì´í„°) === */
  .cal{ width:min(90vw, 520px); margin:12px auto; background:#fff; border:1px solid #ffdca8; border-radius:12px; padding:10px; }
  .cal h3{ margin:4px 0 8px; font-size:14px }
  .cal .row{ display:grid; grid-template-columns:140px 1fr 60px; gap:10px; align-items:center; margin:6px 0; }
  .cal input[type=range]{ width:100% }
  .cal small{ opacity:.7 }
  .guide-on .reel{ outline:2px dashed #3b82f6aa; }
  .strip {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    will-change: transform;
  }
  .strip .item{
    width: 100%; height: var(--H,100%);
    display:flex; place-items: center;
    font-size: clamp(36px,7vw,60px);
    align-items:center;
    justify-content:center;
    line-height:1; 
  }
  .strip .item > img, 
  .strip .item > span{ display:block; }
  .strip .item img{ width:95%; height:auto; display:block; margin:0 auto; }

  @keyframes centerPop {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.25); }
    60%  { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  .strip .item.hit {
    animation: centerPop 650ms cubic-bezier(.2,1,.2,1);
    transform-origin: 50% 50%;
    z-index: 1;
  }

  /* ì¹´ë“œ ì£¼ë³€ í™©ê¸ˆë¹› ê¸€ë¡œìš°(ì ê¹ ë²ˆì©) */
  @keyframes haloBlink {
    0%   { opacity: 0; transform: scale(.9); }
    35%  { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.05); }
  }

  /* ê° ë¦´ ì¤‘ì•™ì— ë§ì¶˜ ê¸€ë¡œìš° ì˜¤ë²„ë ˆì´ */
  .slot-wrap.win .reel::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    /* ì¤‘ì•™ ì¹´ë“œ ì˜ì—­ë§Œ ê°•ì¡°ë˜ë„ë¡ ì•ˆìª½ì„ ë‚¨ê¸°ê³  ë°”ê¹¥ìª½ì„ ë¶€ë“œëŸ½ê²Œ ë²ˆì§ */
    background:
      radial-gradient(ellipse at 50% 50%,
        rgba(255,230,140,.85) 0%,
        rgba(255,210,70,.55) 40%,
        rgba(255,210,70,.20) 60%,
        rgba(255,210,70,0) 80%);
    filter: blur(.4px);
    border-radius: 10px;
    animation: haloBlink 680ms ease-out 1;
  }

  /* ì¤‘ì•™ì— ë©ˆì¶˜ 'ê·¸ ì¹´ë“œ'ë§Œ íŒ íš¨ê³¼ */
  .strip .item.hit {
    animation: centerPop 650ms cubic-bezier(.2,1,.2,1);
    transform-origin: 50% 50%;
    z-index: 1; /* ê²¹ì¹¨ ìš°ì„  */
  }
  .weight-panel{
    position: fixed; top: 40px; right: 40px;
    width: 360px; background:#fff; border:1px solid #ddd; border-radius:10px;
    padding:16px; box-shadow:0 3px 8px rgba(0,0,0,.12); z-index:100; font-size:16px;
  }
  .weight-panel h3{ margin:0 0 10px; font-size:18px; }
  .weight-panel .row{
    display:grid;
    grid-template-columns: 1fr auto auto; /* ì™¼ìª½: name / ê°€ìš´ë°: wwrap / ì˜¤ë¥¸ìª½: pct */
    align-items:center;
    margin:15px 0; padding:4px 0;
    column-gap:16px;                     /* â† name~x1, x1~% ì‚¬ì´ ì—¬ë°± */
  }
  .weight-panel .row:last-child{ border-bottom:0; }
  .weight-panel .name{ justify-self: start; }
  .weight-panel .btn{
    width:42px; height:38px; border-radius:8px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer;
  }
  /* x1 ìì²´ë¥¼ ì™¼ìª½ì— ë”± ë¶™ì´ê¸° */
  .weight-panel .w{
    min-width: 48px;                     /* ë„ˆë¬´ ë„“ì–´ì„œ ìš°ì¸¡ì— ë¶™ë˜ ê²ƒ ì¤„ì´ê¸° */
    text-align: left;                    /* â† right â†’ left */
  }
  .weight-panel .w:focus{ border-color:#60a5fa; box-shadow:0 0 0 3px #93c5fd55; }
  .weight-panel .x{ opacity:.7; }
  /* í™•ë¥ ì€ ì˜¤ë¥¸ìª½ ëì— ê³ ì • */
  .weight-panel .pct{
    justify-self: end;
    min-width: 60px;
    text-align: right;
  }
  .weight-panel .help{ margin-top:10px; font-size:12px; opacity:.7; }
  
  /* x1 ë¬¶ìŒ: ê°€ìš´ë° ì •ë ¬ â†’ ì™¼ìª½ ì •ë ¬ë¡œ */
  .weight-panel .wwrap{
    justify-self: start;                 /* â† center â†’ start */
    position: relative;
    display: inline-flex;
    align-items: center;
    font-weight:500;
  }

  .weight-panel .updown {
    position: absolute;
    right: 5px;                 /* ìˆ«ì ì˜¤ë¥¸ìª½ì— ë¶™ì´ê¸° */
    top: 50%;
    transform: translateY(-50%);
    
    display: flex;
    flex-direction: column;       /* â† í•µì‹¬: ì„¸ë¡œ ë°°ì¹˜ */
    gap: 0px;

    opacity: 0;
    pointer-events: none;
    transition: opacity .15s ease;
  }

  /* í˜¸ë²„í•˜ë©´ ë‚˜íƒ€ë‚¨ */
  .weight-panel .wwrap:hover .updown{
    opacity: 1;
    pointer-events: auto;
  }

  /* ì‘ì€ ì›í˜• ë²„íŠ¼ */
  .weight-panel .updown .btn {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: 1px solid #cfcfcf;
    background: #fff;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,.08);

    /* ê¸€ì ì˜ ë³´ì´ê²Œ */
    font-size: 16px;       /* í¬ê¸° ì¡°ì • */
    font-weight: 500;     /* êµµê²Œ */
    line-height: 1;        /* ì„¸ë¡œ ê°€ìš´ë° */
    color: #333;           /* ê¸€ììƒ‰ */
  }
  .weight-panel .updown .btn:hover{ background:#f5f5f5; }

</style>
</head>
<body>

<div id="stage">
  <div class="slot-wrap" id="wrap">
    <img class="slot-frame" src="KakaoTalk_20250919_112415354.png" alt="frame">

    <!-- ë¦´(ì¹´ë“œ) 3ê°œ -->
    <div class="reel r0" id="reel0"></div>
    <div class="reel r1" id="reel1"></div>
    <div class="reel r2" id="reel2"></div>

    <div class="status-box" id="statusBox">
      <div class="status" id="status">READY</div>
    </div>
  </div>

  <div class="ctrl">
    <button id="btn">START</button>
  </div>
</div>

<!-- ìœ„ì¹˜ ì¡°ì • íŒ¨ë„ -->
<div class="cal" id="cal" hidden>
  <h3>ğŸ“ ìœ„ì¹˜ ì¡°ì • (í”„ë ˆì„ ëŒ€ë¹„ %)</h3>
  <div class="row"><label>TOP(%)</label><input id="rTop" type="range" min="0" max="100" step="0.1"><output id="oTop"></output></div>
  <div class="row"><label>LEFT0(%)</label><input id="rLeft" type="range" min="0" max="100" step="0.1"><output id="oLeft"></output></div>
  <div class="row"><label>WIDTH(%)</label><input id="rW" type="range" min="1" max="50" step="0.1"><output id="oW"></output></div>
  <div class="row"><label>HEIGHT(%)</label><input id="rH" type="range" min="1" max="60" step="0.1"><output id="oH"></output></div>
  <div class="row"><label>GAP(%)</label><input id="rGap" type="range" min="0" max="30" step="0.1"><output id="oGap"></output></div>
  <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
    <button id="btnCopy" style="background:#16a34a">ê°’ ë³µì‚¬</button>
    <small>ì €ì¥ì€ ìë™(ë¸Œë¼ìš°ì € ë¡œì»¬). ê°€ì´ë“œì„ ì€ ìœ„ì¹˜ì¡°ì • ONì¼ ë•Œ ë³´ì…ë‹ˆë‹¤.</small>
  </div>
</div>

<!-- ê°€ì¤‘ì¹˜(ì¹¸ ìˆ˜) íŒ¨ë„ -->
<div class="weight-panel" id="weightPanel">
  <h3>ìŠ¬ë¡¯ë¨¸ì‹  í™•ë¥  (ì‚¬ìš©ì ì¡°ì •)</h3>
  <div class="rows">
    <!-- data-key ë§Œ ìš°ë¦¬ ì‹¬ë³¼ í‚¤ë¡œ ë§ì¶”ë©´ ë¨ -->
    <div class="row" data-key="miss"><span class="name">ê½</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="chicken"><span class="name">ì¹˜í‚¨</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="coffee"><span class="name">ì»¤í”¼</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="coin"><span class="name">ì½”ì¸</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="dahye"><span class="name">ë‹¤í˜œ</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="bomb"><span class="name">í­íƒ„</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
    <div class="row" data-key="seven"><span class="name">7</span><span class="wwrap"><span class="w">x1</span><div class="updown"><button class="btn plus">+</button><button class="btn minus">âˆ’</button></div></span><output class="pct">0%</output></div>
  </div>
  <div class="help">Ait+í´ë¦­ Â±100  /  Ctrl+í´ë¦­ Â±10 / í´ë¦­ Â±1 </div>
</div>

<script>
const BASE_W=900, BASE_H=1200, SCALE_BIAS=0.96;
function viewportSize(){
  const vv=window.visualViewport;
  return vv ? {w:vv.width*vv.scale, h:vv.height*vv.scale} :
               {w:window.innerWidth, h:window.innerHeight};
}
function fit(){
  const {w,h}=viewportSize();
  const raw=Math.min(w/BASE_W,h/BASE_H);
  document.documentElement.style.setProperty('--s', Math.min(raw*SCALE_BIAS,2));
}
window.addEventListener('resize',fit);
if(window.visualViewport){
  visualViewport.addEventListener('resize',fit);
  visualViewport.addEventListener('scroll',fit);
}
fit();

let finalKeys = [null, null, null];
// ===== ìŠ¤í•€/ê°ì† ì„¤ì • =====
const SPIN_TIME_BASE = 3000;   // 1ë²ˆ ë¦´ì˜ ë¹ ë¥¸ íšŒì „ ìœ ì§€ ì‹œê°„(ms)
const SPIN_TIME_STEP = 300;    // ë¦´ë§ˆë‹¤ ì¡°ê¸ˆì”© ë” ì˜¤ë˜
const SPEED_PX  = 8000;   // ë¹ ë¥¸ íšŒì „(ìœ„â†’ì•„ë˜) px/sec
const DECEL_TURNS_BASE = 6;      // ê°ì† êµ¬ê°„ì—ì„œ ì¶”ê°€ë¡œ ë³´ì´ëŠ” ëœë¤ ì•„ì´í…œ ì¤„ ìˆ˜(ë°”í€´ ìˆ˜ ëŠë‚Œ)
const DECEL_TURNS_RAND = 3;      // ê°ì† êµ¬ê°„ ëœë¤ ê°€ì‚°ì¹˜(0~ì´ ê°’-1)
const DECEL_MS_BASE = 950;    // ê°ì† ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(ms)
const DECEL_MS_STEP = 150;    // ë¦´ë§ˆë‹¤ ì¡°ê¸ˆ ë” ê¸¸ê²Œ(ì„¸ ë²ˆì§¸ ë¦´ì´ ê°€ì¥ ëŠ¦ê²Œ ë©ˆì¶¤)

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¦´ ë¡œì§(ê°„ë‹¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SYMBOLS = [
  { key:'chicken', label:'ì¹˜í‚¨', glyph:'<img src="chicken.png" alt="ì¹˜í‚¨">' },
  { key:'coffee',  label:'ì»¤í”¼',  glyph:'<img src="coffee.png"  alt="ì»¤í”¼">' },
  { key:'coin',    label:'ì½”ì¸',  glyph:'<img src="coin.png"    alt="ì½”ì¸">' },
  { key:'dahye',   label:'ë‹¤í˜œ',  glyph:'<img src="dahye.png"   alt="ë‹¤í˜œ">' },
  { key:'bomb',    label:'í­íƒ„',  glyph:'<img src="bomb.png"    alt="í­íƒ„">' },
  { key:'seven',   label:'7',     glyph:'<img src="seven.png"   alt="7">' },
];
let dist = { wins:{ chicken:3, coffee:3, coin:4, dahye:1.5, bomb:1.5, seven:1 }, miss:86 };

const reels=[0,1,2].map(i=>document.getElementById('reel'+i));
const statusEl=document.getElementById('status');
const btn=document.getElementById('btn');
let busy=false;

const wrap = document.getElementById('wrap');

function finishFromVisible(){
  const [a,b,c] = finalKeys;
  if (a && a === b && b === c){
    status(`ë‹¹ì²¨! [${labelOf(a)}] x3`, true);
    wrap.classList.add('win');            // ê¸€ë¡œìš° íš¨ê³¼

    // â˜… ì„¸ ì¹´ë“œê°€ ì™„ì „íˆ ë©ˆì¶˜ í›„ í•œêº¼ë²ˆì— íŒ íš¨ê³¼
    const reelsEls = document.querySelectorAll('.reel');
    reelsEls.forEach(reel=>{
      const last = reel.querySelector('.strip .item:last-child');
      if(last) last.classList.add('hit');
    });
    setTimeout(()=>{
      reelsEls.forEach(reel=>{
        const last = reel.querySelector('.strip .item:last-child');
        if(last) last.classList.remove('hit');
      });
      wrap.classList.remove('win');
    }, 650); // íŒ ì§€ì† ì‹œê°„ê³¼ ë§ì¶”ê¸°

  } else {
    status('ê½ (ë¶ˆì¼ì¹˜)', false);
  }
}

btn.addEventListener('click', spin);
function spin(){
  if(busy) return; busy=true; btn.disabled = true; status('Â· Â· Â·');
  finalKeys = [null, null, null];
  const outcome = drawOutcome(dist);
  const targets = (outcome.type === 'win') ? [outcome.symbol,outcome.symbol,outcome.symbol] : drawMissTriple();
  reels.forEach(el=>el.classList.add('spinning'));
  const stops=[900,1300,1700];
  targets.forEach((k,i)=> cycleReelTo(i,k,stops[i],()=>{
    if(i===2){ reels.forEach(el=>el.classList.remove('spinning')); finishFromVisible(); busy=false; btn.disabled = false; }
  }));
}
function finish(o){ status(o.type==='win'?`ë‹¹ì²¨! [${labelOf(o.symbol)}] x3`:'ê½ (ë¶ˆì¼ì¹˜)', o.type==='win'); }
function status(msg,win){ statusEl.textContent=msg; if (win === true) statusEl.className = 'status win'; else if (win === false) statusEl.className = 'status lose'; }
function labelOf(key){ return SYMBOLS.find(s=>s.key===key)?.label||key; }
function cycleReelTo(idx, key, _unusedMs, done){
  const reel = reels[idx];
  const H = reel.offsetHeight;

  // â”€â”€ PHASE A: ë¹ ë¥¸ ì—°ì† íšŒì „(ìœ ì§€) â€” requestAnimationFrameë¡œ ë¬´í•œ ìŠ¤í¬ë¡¤
  // stripLoop: ëœë¤ ì•„ì´í…œ ì—¬ëŸ¬ ê°œë¥¼ ìŒ“ì•„ ìœ„â†’ì•„ë˜ë¡œ íë¥´ê²Œ ë§Œë“¤ê³ , ë§¨ ìœ„ê°€ ì§€ë‚˜ê°€ë©´ ë’¤ì— ë‹¤ì‹œ ë¶™ì„
  const stripLoop = document.createElement('div');
  stripLoop.className = 'strip';
  stripLoop.style.setProperty('--H', H + 'px');

  const pool = [];                     // ë£¨í”„ìš© ì´ˆê¸° ëª©ë¡
  for(let i=0;i<10;i++){
    const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    pool.push(s);
  }
  stripLoop.innerHTML = pool.map(s=>`<div class="item">${s.glyph}</div>`).join('');
  reel.innerHTML = '';
  reel.appendChild(stripLoop);

  let y = 0;                           // í˜„ì¬ ìŠ¤í¬ë¡¤ ê±°ë¦¬(px)
  let rafId = 0;
  let last = performance.now();
  const speed = SPEED_PX;              // px/sec
  const spinTime = SPIN_TIME_BASE + SPIN_TIME_STEP * idx; // ë¦´ë§ˆë‹¤ ì¡°ê¸ˆ ë” ê¸¸ê²Œ
  const spinEndAt = last + spinTime;

  function tick(now){
    const dt = (now - last) / 1000;    // ì´ˆ ë‹¨ìœ„
    last = now;
    y += speed * dt;

    // í•œ ì¹¸(=H) ë„˜ì–´ê°€ë©´ ë§¨ ìœ„ ì•„ì´í…œ ì œê±°í•˜ê³  ë§¨ ì•„ë˜ë¡œ í•˜ë‚˜ ë” ì¶”ê°€ â†’ ë¬´í•œë£¨í”„
    while (y >= H){
      y -= H;
      // ë§¨ ìœ„ ì œê±° & ë§¨ ì•„ë˜ ì¶”ê°€
      const lastEl = stripLoop.lastElementChild;
      if (lastEl) stripLoop.removeChild(lastEl);
      const s  = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = s.glyph;
      stripLoop.insertBefore(el, stripLoop.firstChild);
    }

    stripLoop.style.transform = `translateY(${Math.round(y)}px) translateY(${-H/2}px)`;

    if(now < spinEndAt){
      rafId = requestAnimationFrame(tick);
    }else{
      // PHASE A ì¢…ë£Œ â†’ PHASE B(ê°ì† ì •ì§€)ë¡œ ì „í™˜
      phaseB();
    }
  }
  rafId = requestAnimationFrame(tick);

  // â”€â”€ PHASE B: ê°ì†í•˜ë©° ëª©í‘œ ì‹¬ë³¼ì—ì„œ ë¶€ë“œëŸ½ê²Œ ì •ì§€
  function phaseB(){
    cancelAnimationFrame(rafId);

    const stripStop = document.createElement('div');
    stripStop.className = 'strip';
    stripStop.style.setProperty('--H', H + 'px');

    // ê°ì† êµ¬ê°„ì—ì„œ ì—¬ëŸ¬ ì•„ì´í…œì´ ë” ë‚´ë ¤ì˜¤ë‹¤ê°€ ë§ˆì§€ë§‰ì— ëª©í‘œê°€ ë³´ì´ê²Œ êµ¬ì„±
    const turns = DECEL_TURNS_BASE + Math.floor(Math.random()*DECEL_TURNS_RAND) + idx; // ë¦´ë§ˆë‹¤ ì‚´ì§ ë” ë§ê²Œ
    const seq = [];
    for(let i=0;i<turns;i++){
      const s = SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
      seq.push(s);
    }
    // ë§ˆì§€ë§‰ì€ ë¬´ì¡°ê±´ ëª©í‘œ ì‹¬ë³¼
    const target = SYMBOLS.find(s=>s.key===key) || SYMBOLS[0];
    seq.push(target);

    stripStop.innerHTML = seq.map(s=>`<div class="item">${s.glyph}</div>`).join('');
    reel.innerHTML = '';
    reel.appendChild(stripStop);

    // ì‹œì‘: ë” ìœ„ìª½(-lead)ì—ì„œ ì•„ë˜ë¡œ ê°ì†í•´ ì¤‘ì•™ì—ì„œ ë©ˆì¶¤
    const total = H * (seq.length - 1); 
    const dur   = DECEL_MS_BASE + DECEL_MS_STEP * idx;
    const lead  = H * 4; // ê°ì† ì „ì— ë” ë§ì´ ë‚´ë ¤ì˜¤ê²Œ(ì›í•˜ë©´ 2~6Hë¡œ ì¡°ì ˆ)

    stripStop.style.transition = 'none';
    stripStop.style.transform = `translateY(${Math.round(-total)}px) translateY(${-H/2}px)`;

    requestAnimationFrame(()=>{
      stripStop.style.transition = `transform ${dur}ms cubic-bezier(.08,.9,.18,1)`;
      stripStop.style.transform  = `translate3d(0, ${-total}px, 0)`;      // ì¤‘ì•™ì—ì„œ ì •ì§€
    });

    // ì •ì§€ í›„: ì¤‘ì•™ì— ë©ˆì¶˜ 'ê·¸ ì¹´ë“œ'ë§Œ íŒ íš¨ê³¼
    setTimeout(()=>{
      finalKeys[idx] = key;
      done && done();
    }, dur + 30);
  }
}

function drawOutcome(d){
  const sumWins = Object.values(d.wins).reduce((a,b)=>a+b,0);
  const r = Math.random() * 100;
  if (r < d.miss) return { type:'miss' };
  // ë‚¨ì€ êµ¬ê°„(100 - miss)ì—ì„œ win ì‹¬ë³¼ ê°€ì¤‘ ì¶”ì¶œ
  let rr = Math.random() * sumWins;
  for (const k of Object.keys(d.wins)){
    rr -= d.wins[k];
    if (rr <= 0) return { type:'win', symbol:k };
  }
  return { type:'miss' }; // fallback
}

function drawMissTriple(){
  const pick=()=>SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)].key;
  let a=pick(),b=pick(),c=pick();
  if(a===b&&b===c){ const others=SYMBOLS.filter(s=>s.key!==a); c=others[Math.floor(Math.random()*others.length)].key; }
  return [a,b,c];
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìœ„ì¹˜ ì¡°ì •(ìº˜ë¦¬ë¸Œë ˆì´í„°) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const cal = document.getElementById('cal');
const btnCal = document.getElementById('btnCal');
const root = document.documentElement;

const sliders = {
  top : {el:document.getElementById('rTop'), css:'--REEL_TOP_PCT', out:document.getElementById('oTop')},
  left: {el:document.getElementById('rLeft'), css:'--REEL_LEFT0_PCT', out:document.getElementById('oLeft')},
  w   : {el:document.getElementById('rW'), css:'--REEL_W_PCT', out:document.getElementById('oW')},
  h   : {el:document.getElementById('rH'), css:'--REEL_H_PCT', out:document.getElementById('oH')},
  gap : {el:document.getElementById('rGap'), css:'--REEL_GAP_PCT', out:document.getElementById('oGap')},
};

initSliders();
if (btnCal) btnCal.addEventListener('click', ()=> {
  const on = cal.toggleAttribute('hidden')===false; // hidden ì œê±°ë˜ë©´ ON
  document.body.classList.toggle('guide-on', on);
});
const btnCopy = document.getElementById('btnCopy');
if (btnCopy) btnCopy.addEventListener('click', copyVars);

function initSliders(){
  // ê¸°ì¡´ ê°’(ë¡œì»¬ ì €ì¥) ë¶ˆëŸ¬ì˜¤ê¸°
  const saved = JSON.parse(localStorage.getItem('reelPosPct')||'{}');
  for(const k in sliders){
    const v = saved[sliders[k].css] ?? getPct(sliders[k].css);
    sliders[k].el.value = v;
    sliders[k].out.textContent = v + '%';
    root.style.setProperty(sliders[k].css, v);
    sliders[k].el.addEventListener('input', e=>{
      const val = e.target.value;
      root.style.setProperty(sliders[k].css, val);
      sliders[k].out.textContent = val + '%';
      saveVars();
    });
  }
}
function getPct(cssVar){
  const v = getComputedStyle(root).getPropertyValue(cssVar).trim();
  return v ? parseFloat(v) : 0;
}
function saveVars(){
  const data={};
  for(const k in sliders){ data[sliders[k].css] = parseFloat(sliders[k].el.value); }
  localStorage.setItem('reelPosPct', JSON.stringify(data));
}
function copyVars(){
  const s = `:root{
  --REEL_TOP_PCT: ${sliders.top.el.value};
  --REEL_LEFT0_PCT: ${sliders.left.el.value};
  --REEL_W_PCT: ${sliders.w.el.value};
  --REEL_H_PCT: ${sliders.h.el.value};
  --REEL_GAP_PCT: ${sliders.gap.el.value};
}`;
  navigator.clipboard.writeText(s);
  alert('CSS ë³€ìˆ˜ë¥¼ ë³µì‚¬í–ˆì–´ìš”. ìŠ¤íƒ€ì¼ì‹œíŠ¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
}
window.addEventListener('load', () => {
  reels.forEach(reel => {
    const H = reel.offsetHeight;
    const strip = document.createElement('div');
    strip.className = 'strip';
    strip.style.setProperty('--H', H + 'px');

    // 1) ë¬´ì‘ìœ„ ì‹¬ë³¼ 1ì¥
    const s = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)];

    // 2) ë˜ëŠ” 'ê³ ì •'ìœ¼ë¡œ ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´ ìœ„ í•œ ì¤„ ëŒ€ì‹  ì˜ˆ: const s = SYMBOLS.find(x => x.key === 'chicken');
    strip.innerHTML = `<div class="item">${s.glyph}</div>`;

    reel.innerHTML = '';
    reel.appendChild(strip);
  });
});

// --- ê°€ì¤‘ì¹˜ íŒ¨ë„ ë¡œì§ ---
(function(){
  const panel = document.getElementById('weightPanel');
  if(!panel) return;

  // í˜„ì¬ weight ì½ê¸°
  function readWeights(){
    const rows = [...document.querySelectorAll('#weightPanel .row')];
    const w = {};
    rows.forEach(r=>{
      const key = r.dataset.key;
      const raw = r.querySelector('.w').textContent.trim();
      const v = parseFloat(raw.replace(/[^\d.]/g, '')); // 'x113' -> 113
      w[key] = isNaN(v) ? 0 : v;
    });
    return w;
  }

  // weight â†’ % í™˜ì‚°í•´ì„œ UI/ê²Œì„(dist)ì— ë°˜ì˜
  function applyWeights(){
    const rows = [...panel.querySelectorAll('.row')];
    const w = readWeights();
    let sum = Object.values(w).reduce((a,b)=>a+b,0);
    if (sum <= 0) { sum = 1; w.miss = 1; }   // 0 ë¶„ëª¨ ë°©ì§€

    // UI í‘œì‹œ + dist ê°±ì‹ (ìš°ë¦¬ ìŠ¬ë¡¯ ë¡œì§ì— ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    rows.forEach(r=>{
      const key = r.dataset.key;
      const pct = (w[key] / sum) * 100;
      r.querySelector('.pct').value = (Math.round(pct*100)/100).toFixed(2) + '%';
    });

    // distì— í¼ì„¼íŠ¸ ë°˜ì˜
    dist.miss         = (w.miss    / sum) * 100;
    dist.wins.chicken = (w.chicken / sum) * 100;
    dist.wins.coffee  = (w.coffee  / sum) * 100;
    dist.wins.coin    = (w.coin    / sum) * 100;
    dist.wins.dahye   = (w.dahye   / sum) * 100;
    dist.wins.bomb    = (w.bomb    / sum) * 100;
    dist.wins.seven   = (w.seven   / sum) * 100;
  }

  // ë²„íŠ¼(+/â€“) í´ë¦­ â†’ ê°€ì¤‘ì¹˜ ì¦ê°
  panel.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn');
    if(!btn) return;
    const row = btn.closest('.row');
    const cell = row.querySelector('.w');

    let step = 1;
    if (e.altKey) step = 100;
    else if (e.ctrlKey || e.metaKey) step = 10;

    let v = parseFloat(cell.textContent.replace(/[^\d.]/g, "")) || 0;
    if (btn.classList.contains('plus')) {
      v += step;                      // í”ŒëŸ¬ìŠ¤ë©´ ì¦ê°€
    } else if (btn.classList.contains('minus')) {
      v -= step;                      // ë§ˆì´ë„ˆìŠ¤ë©´ ê°ì†Œ
    }
    if (v < 0) v = 0;

    cell.textContent = "x" + v;
    applyWeights();
  });

  // ê°€ì¤‘ì¹˜ ìˆ«ì ì§ì ‘ ìˆ˜ì •: Enter/blur ë•Œ ë°˜ì˜
  panel.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && e.target.classList.contains('w')){
      e.preventDefault(); e.target.blur();
    }
  });
  panel.addEventListener('blur', (e)=>{
    if(e.target.classList.contains('w')){
      let v = parseFloat(e.target.textContent.trim());
      if (isNaN(v) || v < 0) v = 0;
      e.target.textContent = (Math.round(v*100)/100).toString();
      applyWeights();
    }
  }, true);

  // ì´ˆê¸° 1íšŒ ë°˜ì˜
  applyWeights();
})();

</script>
</body>
</html>
